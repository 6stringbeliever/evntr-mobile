<!DOCTYPE html>
<html class="no-js">
  <head lang="en">
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Evntr - A Fake Events App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A fake events app for creating awesome fake events.">
    <link rel="stylesheet" href="css/style.css">
    <script>
      /* Test for js */
      (function(h){
        h.className = h.className.replace('no-js', 'js')
      })(document.documentElement)
    </script>
  </head>
  <body>
    <header>
      <div class="container header">
        <h1><a href="/">Evntr</a></h1>
        <nav>
          <ul class="header-menu">
            <li><a href="signup.html">Sign Up</a></li>
            <li><a href="login.html">Log In</a></li>
          </ul>
        </nav>
      </div>
    </header>
    <!--

    2) The app should allow users to create a new event. Each event should, at a minimum, allow a user to set:

    x Name of the event
    x Type of the event (birthday party, conference talk, wedding, etc.)
    x Event host (could be an individualâ€™s name or an organization)
    Event start date and time
    Event end date and time
    * Guest list
    Location
    x Optional message to the guests with additional information about the event
    -->
    <main class="container-horizontal">
      <section class="formsection">
        <h2>Create a New Event</h2>
        <h3>Event Details</h3>
        <form action="" id="create-event" novalidate>
          <div class="inp-grp">
            <label for="event-name">What's the name of the event?</label>
            <input type="text" name="event-name" id="event-name" class="inp-lrg" placeholder="e.g., Porkfest 2016" autofocus>
          </div>
          <div class="inp-grp">
            <label for="event-host">Who is the host of the event?</label>
            <input type="text" name="event-host" id="event-host" class="inp-lrg" placeholder="Person or organization name">
          </div>
          <div class="inp-grp">
            <label for="event-type">What is the purpose of the event?</label>
            <input list="event-type-list" name="event-type" id="event-type" class="inp-lrg" placeholder="e.g., Birthday, Business Meeting">
            <datalist id="event-type-list">
              <option value="Birthday" />
              <option value="Book Club" />
              <option value="Business Meeting" />
              <option value="Concert" />
              <option value="Corporate Retreat" />
              <option value="Meetup" />
              <option value="Pork Festival" />
              <option value="Speed Dating" />
            </datalist>
          </div>
          <hr />
          <div id="event-date-time">
            <h3>When is the event?</h3>
            <p>Start Time</p>
              <div class="inp-grp">
                <label for="event-date-st">Date</label>
                <input type="date" name="event-date-st" class="inp-lrg" id="event-date-st">
              </div>
              <div class="inp-grp">
                <label for="event-time-st">Time</label>
                <input type="time" name="event-time-st" class="inp-lrg" id="event-time-st">
              </div>


            <div class="inp-grp">
              <input type="checkbox" id="event-all-day" name="event-all-day">
              <label for="event-all-day">All day?</label>
            </div>
            <p>End Time</p>
            <div class="inp-grp">
              <label for="event-date-end">Date</label>
              <input type="date" name="event-date-end" class="inp-lrg" id="event-date-end">
            </div>
            <div class="inp-grp">
              <label for="event-time-end">Time</label>
              <input type="time" name="event-time-end" class="inp-lrg" id="event-time-end">
            </div>
          </div>
          <hr/>
          <div>
            <h2>Where is the event?</h2>
            <button class="btn-function" id="btn-near-me" type="button">Get suggestions near me</button>
            <p>or</p>
            <div class="inp-grp-horiz">
              <label for="event-near-zip">Near ZIP code</label>
              <input type="text" name="event-near-zip" class="inp-sm" id="event-near-zip" autocomplete="email">
              <button type="button" class="btn-function" id="btn-near-zip">Get suggestions</button>
            </div>
            <p>or</p>
            <div class="inp-grp">
              <label for="event-loc">Enter the location.</label>
              <input type="text" name="event-loc" id="event-loc" class="inp-lrg" placeholder="Person or organization name">
            </div>
            <input type="hidden" id="event-loc-pic" name="event-loc-pic">
          </div>
          <hr />
          <div>
            <h2>Guest List</h2>
            <div class="inp-grp">
              <label for="event-guest">Add a guest by email</label>
              <div class="inp-grp-compound">
                <input type="email" id="event-guest" name="event-guest" class="inp-grp-compound__left" placeholder="guest@example.com"><button class="inp-grp-compound__right btn-secondary-function" id="add-guest" type="button">Add</button>
              </div>
              <div id="guest-list"></div>
            </div>
          </div>
          <hr />
          <div>
            <h2>Anything else you need to tell your guests?</h2>
            <div class="inp-grp">
              <label for="event-msg">Enter any additional details for your guests</label>
              <textarea id="event-msg" class="inp-lrg" name="event-msg"></textarea>
            </div>
          </div>

          <input type="submit" id="submit" class="btn-primary btn-lrg" value="Create event">
        </form>
      </section>
    </main>
    <script src="js/app.js"></script>
    <script>
      var validation = ValidationModule();

      validation.initValidation(document.getElementById('create-event'),
        document.getElementById('submit'));

      // Guest list module
      (function(addButton, emailField, listDiv) {
        'use strict';

        var guests = [];

        var _getGuestListHTML = function() {
          var output = '';
          if (guests.length >= 1) {
            output += '<ul class="event-guest-list">';
            for (var i = 0; i < guests.length; i++) {
              output += '<li>' + guests[i] + ' ';
              output += '<button id="del-guest-' + i;
              output += '" type="button">Remove</button>';
              output += '<input type="hidden" name="event-guests-' + i + '" ';
              output += 'value="' + guests[i] + '">';
              output += '</li>';
            }
            output += '</ul>';
          }
          return output;
        };

        addButton.setAttribute('disabled', 'true');

        emailField.addEventListener('keyup', function() {
          if (emailField.checkValidity()) {
            addButton.removeAttribute('disabled');
          } else {
            addButton.setAttribute('disabled', 'true');
          }
        });

        addButton.addEventListener('click', function() {
          if (emailField.checkValidity()) {
            guests.push(emailField.value);
            emailField.value = '';
            listDiv.innerHTML = _getGuestListHTML();
          }
        });

        listDiv.addEventListener('click', function(e) {
          var reg = /del-guest-([0-9]+)/;
          var match = reg.exec(e.target.id);
          if (match !== null) {
            guests.splice(match[1], 1);
            listDiv.innerHTML = _getGuestListHTML();
          }
        });

      })(document.getElementById('add-guest'),
        document.getElementById('event-guest'),
        document.getElementById('guest-list'));

      // Event time module
      (function(startDateField, startTimeField, endDateField,
        endTimeField, allDayField, dateTimeSection) {

        var startTime = resetStartTime();
        var endTime = resetEndTime(startTime);

        setDateTimeFields(startTime, startDateField, startTimeField);
        setDateTimeFields(endTime, endDateField, endTimeField);

        allDayField.addEventListener('click', function(e) {
          if (e.target.checked) {
            startTimeField.parentNode.style.display = 'none';
            endTimeField.parentNode.style.display = 'none';
          } else {
            startTimeField.parentNode.style.display = 'block';
            endTimeField.parentNode.style.display = 'block';
          }
        });

        dateTimeSection.addEventListener('focusout', function(e) {
          var startTime;
          var endTime;
          if (!validateEndTime()) {
            startTime = getDateFromFields(startDateField, startTimeField);
            endTime = resetEndTime(startTime);
            setDateTimeFields(endTime, endDateField, endTimeField);
          }
        });

        function validateEndTime() {
          var st = getDateFromFields(startDateField, startTimeField);
          var end = getDateFromFields(endDateField, endTimeField);
          return st <= end;
        }

        function getDateFromFields(dateField, timeField) {
          return new Date(dateField.value + " " + timeField.value);
        }

        function setDateTimeFields(dateVal, dateField, timeField) {
          dateField.value = getDateString(dateVal);
          timeField.value = getTimeString(dateVal);
        }

        function resetStartTime() {
          var now = new Date();
          if (now.getMinutes() >= 29) {
            now.setHours(now.getHours() + 1);
            now.setMinutes(0);
          } else {
            now.setMinutes(30);
          }
          now.setSeconds(0);
          return now;
        }

        // Returns startTime plus 30 minutes
        function resetEndTime(startTime) {
          return new Date(startTime.getTime() + 1800000);
        }

        function getDateString(date) {
          var month = date.getMonth() + 1;
          var monthSt = (month < 10) ? '0' + month : '' + month;
          var day = date.getDate();
          var daySt = (day < 10) ? '0' + day : '' + day;
          return date.getFullYear() + '-' + monthSt + '-' + daySt;
        }

        function getTimeString(time) {
          var hours = time.getHours();
          var hoursSt = (hours < 10) ? '0' + hours : '' + hours;
          var minutes = time.getMinutes();
          var minutesSt = (minutes < 10) ? '0' + minutes : '' + minutes;
          return hoursSt + ':' + minutesSt;
        }

      })(document.getElementById('event-date-st'),
        document.getElementById('event-time-st'),
        document.getElementById('event-date-end'),
        document.getElementById('event-time-end'),
        document.getElementById('event-all-day'),
        document.getElementById('event-date-time')
      );

      // Event location module
      (function(global) {
        'use strict';

        var reqDataBtn = document.getElementById('btn-near-me');
        reqDataBtn.addEventListener('click', function(event) {
        var query = "https://api.foursquare.com/v2/venues/explore?ll=44.3,37.2" +
                "&client_id=HPTKFD3QU12Y0FPPQ0OVTZ51RFAYJ5L4104MNJJL0CW2HEEQ" +
                "&client_secret=YLBK5PYZW4FZNK0QIQX5SCJOQS4TYYEHR2LZ2SHYGJLXJCLE" +
                "&v=20130815";

        var backend = FauxBackendModule(global);

          fetch(query)
          .then(function(response){
            if(response.ok) {
              console.log('good job');
              response.json().then(function(json) {
                console.log(json);
              });
            }
          });
          event.preventDefault();
        });

      })(window);
    </script>
  </body>
</html>
