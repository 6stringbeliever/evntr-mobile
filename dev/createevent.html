<!DOCTYPE html>
<html class="no-js">
  <head lang="en">
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Evntr - A Fake Events App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A fake events app for creating awesome fake events.">
    <link rel="stylesheet" href="css/style.css">
    <script>
      /* Test for js */
      (function(h){
        h.className = h.className.replace('no-js', 'js')
      })(document.documentElement)
    </script>
  </head>
  <body>
    <header>
      <div class="container header">
        <h1><a href="/">Evntr</a></h1>
        <nav>
          <ul class="header-menu">
            <li><a href="signup.html">Sign Up</a></li>
            <li><a href="login.html">Log In</a></li>
          </ul>
        </nav>
      </div>
    </header>
    <main class="container-horizontal">
      <section class="formsection">
        <h2>Create a New Event</h2>
        <h3>Event Details</h3>
        <form action="" id="create-event" novalidate>
          <div class="inp-grp">
            <label for="event-name">What's the name of the event?</label>
            <input type="text" name="event-name" id="event-name" class="inp-lrg" placeholder="e.g., Porkfest 2016" autofocus>
          </div>
          <div class="inp-grp">
            <label for="event-host">Who is the host of the event?</label>
            <input type="text" name="event-host" id="event-host" class="inp-lrg" placeholder="Person or organization name">
          </div>
          <div class="inp-grp">
            <label for="event-type">What is the purpose of the event?</label>
            <input list="event-type-list" name="event-type" id="event-type" class="inp-lrg" placeholder="e.g., Birthday, Business Meeting">
            <datalist id="event-type-list">
              <option value="Birthday" />
              <option value="Book Club" />
              <option value="Business Meeting" />
              <option value="Concert" />
              <option value="Corporate Retreat" />
              <option value="Meetup" />
              <option value="Pork Festival" />
              <option value="Speed Dating" />
            </datalist>
          </div>
          <hr />
          <div id="event-date-time">
            <h3>When is the event?</h3>
            <p>Start Time</p>
              <div class="inp-grp">
                <label for="event-date-st">Date</label>
                <input type="date" name="event-date-st" class="inp-lrg" id="event-date-st">
              </div>
              <div class="inp-grp">
                <label for="event-time-st">Time</label>
                <input type="time" name="event-time-st" class="inp-lrg" id="event-time-st">
              </div>
            <div class="inp-grp">
              <input type="checkbox" id="event-all-day" name="event-all-day">
              <label for="event-all-day">All day?</label>
            </div>
            <p>End Time</p>
            <div class="inp-grp">
              <label for="event-date-end">Date</label>
              <input type="date" name="event-date-end" class="inp-lrg" id="event-date-end">
            </div>
            <div class="inp-grp">
              <label for="event-time-end">Time</label>
              <input type="time" name="event-time-end" class="inp-lrg" id="event-time-end">
            </div>
          </div>
          <hr/>
          <div>
            <h2>Where is the event?</h2>
            <div class="inp-grp">
              <button id="btn-get-sug" type="button" class="btn-secondary-function btn-lrg">Get Suggestions</button>
            </div>
            <div class="inp-grp">
              <label for="event-loc-name">Enter the location name</label>
              <input type="text" name="event-loc-name" id="event-loc-name" class="inp-lrg" placeholder="e.g., Starbucks">
            </div>
            <div class="inp-grp">
              <label for="event-loc-addr">Enter address</label>
              <input type="text" name="event-loc-addr" id="event-loc-addr" class="inp-lrg" placeholder="e.g., 855 Peachtree St.">
            </div>
            <input type="hidden" name="event-loc-pic" id="event-loc-pic">
          </div>
          <hr />
          <div>
            <h2>Guest List</h2>
            <div class="inp-grp">
              <label for="event-guest">Add a guest by email</label>
              <div class="inp-grp-compound">
                <input type="email" id="event-guest" name="event-guest" class="inp-grp-compound__left" placeholder="guest@example.com"><button class="inp-grp-compound__right btn-secondary-function" id="add-guest" type="button">Add</button>
              </div>
              <div id="guest-list"></div>
            </div>
          </div>
          <hr />
          <div>
            <h2>Anything else you need to tell your guests?</h2>
            <div class="inp-grp">
              <label for="event-msg">Enter any additional details for your guests</label>
              <textarea id="event-msg" class="inp-lrg" name="event-msg"></textarea>
            </div>
          </div>
          <input type="submit" id="submit" class="btn-primary btn-lrg" value="Create event">
        </form>
      </section>
    </main>
    <div id="loc-modal" class="modal modal-hidden">
      <h2>Choose a location</h2>
      <button type="button" class="close">Close</button>
      <button class="btn-function" id="btn-near-me" type="button">Get suggestions near me</button>
      <p>or</p>
      <div class="inp-grp-horiz">
        <label for="event-near-loc">Near location</label>
        <input type="text" name="event-near-loc" class="inp-sm" id="event-near-loc" placeholder="e.g., Atlanta, GA or 30312">
        <button type="button" class="btn-function" id="btn-near-loc">Get suggestions</button>
      </div>
      <p class="msg-area"></p>
      <ul id="loc-sug-list">
      </ul>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.2.1/mustache.min.js"></script>
    <script src="js/app.js"></script>
    <script id="tmpl-guest-list" type="x-tmpl-mustache">
      <ul>
        {{ #name }}
        <li>{{ . }}<button id="del-guest-{{ index }}" type="button">Remove</button>
        <input type="hidden" name="event-guests-{{ index }}" value="{{ name }}"</li>{{ incIndex }}
        {{ /name }}
      </ul>
    </script>
    <script id="tmpl-loc-item" type="x-tmpl-mustache">
      <li>
        <p>{{ name }}</p>
        <button type="button" id="loc-sug-item-{{ index }}">Select</button>
        <p>{{ location }}</p>
      </li>
    </script>
    <script>
      // TODO Don't validate guest input field
      // TODO Formatting on start date and time
      // TODO Formatting on add guest area and list
      // TODO Highlight end time when it changes
      // TODO Progressive enhancements and feature detection
      // TODO Set required fields
      // TODO Formatting on where is event
      // TODO Event location pic

      var validation = ValidationModule();

      validation.initValidation(document.getElementById('create-event'),
        document.getElementById('submit'));

      var backend = FauxBackendModule(window);

      // Guest list module
      (function(addButton, emailField, listDiv) {
        'use strict';

        var guests = { name: [],
          index: function() {
            return window['INDEX'];
          },
          incIndex: function() {
            ++window['INDEX'];
          },
          resetIndex: function() {
            window['INDEX'] = 0;
          }
        };

        var templ = document.getElementById('tmpl-guest-list').innerHTML;
        Mustache.parse(templ);

        var getGuestListHTML = function() {
          guests.resetIndex();
          return Mustache.render(templ, guests);
        };

        addButton.setAttribute('disabled', 'true');

        emailField.addEventListener('keyup', function() {
          if (emailField.checkValidity()) {
            addButton.removeAttribute('disabled');
          } else {
            addButton.setAttribute('disabled', 'true');
          }
        });

        addButton.addEventListener('click', function() {
          if (emailField.checkValidity()) {
            guests.name.push(emailField.value);
            emailField.value = '';
            listDiv.innerHTML = getGuestListHTML();
          }
        });

        listDiv.addEventListener('click', function(e) {
          var reg = /del-guest-([0-9]+)/;
          var match = reg.exec(e.target.id);
          if (match !== null) {
            guests.name.splice(match[1], 1);
            listDiv.innerHTML = getGuestListHTML();
          }
        });

      })(document.getElementById('add-guest'),
        document.getElementById('event-guest'),
        document.getElementById('guest-list'));

      // Event time module
      (function(startDateField, startTimeField, endDateField,
        endTimeField, allDayField, dateTimeSection) {

        var startTime = resetStartTime();
        var endTime = resetEndTime(startTime);

        setDateTimeFields(startTime, startDateField, startTimeField);
        setDateTimeFields(endTime, endDateField, endTimeField);

        allDayField.addEventListener('click', function(e) {
          if (e.target.checked) {
            startTimeField.parentNode.style.display = 'none';
            endTimeField.parentNode.style.display = 'none';
          } else {
            startTimeField.parentNode.style.display = 'block';
            endTimeField.parentNode.style.display = 'block';
          }
        });

        dateTimeSection.addEventListener('focusout', function(e) {
          var startTime;
          var endTime;
          if (!validateEndTime()) {
            startTime = getDateFromFields(startDateField, startTimeField);
            endTime = resetEndTime(startTime);
            setDateTimeFields(endTime, endDateField, endTimeField);
          }
        });

        function validateEndTime() {
          var st = getDateFromFields(startDateField, startTimeField);
          var end = getDateFromFields(endDateField, endTimeField);
          return st <= end;
        }

        function getDateFromFields(dateField, timeField) {
          return new Date(dateField.value + " " + timeField.value);
        }

        function setDateTimeFields(dateVal, dateField, timeField) {
          dateField.value = getDateString(dateVal);
          timeField.value = getTimeString(dateVal);
        }

        function resetStartTime() {
          var now = new Date();
          if (now.getMinutes() >= 29) {
            now.setHours(now.getHours() + 1);
            now.setMinutes(0);
          } else {
            now.setMinutes(30);
          }
          now.setSeconds(0);
          return now;
        }

        // Returns startTime plus 30 minutes
        function resetEndTime(startTime) {
          return new Date(startTime.getTime() + 1800000);
        }

        function getDateString(date) {
          var month = date.getMonth() + 1;
          var monthSt = (month < 10) ? '0' + month : '' + month;
          var day = date.getDate();
          var daySt = (day < 10) ? '0' + day : '' + day;
          return date.getFullYear() + '-' + monthSt + '-' + daySt;
        }

        function getTimeString(time) {
          var hours = time.getHours();
          var hoursSt = (hours < 10) ? '0' + hours : '' + hours;
          var minutes = time.getMinutes();
          var minutesSt = (minutes < 10) ? '0' + minutes : '' + minutes;
          return hoursSt + ':' + minutesSt;
        }

      })(document.getElementById('event-date-st'),
        document.getElementById('event-time-st'),
        document.getElementById('event-date-end'),
        document.getElementById('event-time-end'),
        document.getElementById('event-all-day'),
        document.getElementById('event-date-time')
      );

      // Event location module
      (function(global, btnNearMe, inpNearLoc, btnNearLoc, inpLocattion, inpAddr,
        inpHiddenPic, getSugBtn, suggestionModal, suggestionList) {
        'use strict';

        var modalHidden = true;
        var venues;

        btnNearMe.addEventListener('click', function(e) {
          setModalMessage('Getting your current location.');
          clearSuggestions();
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = position.coords;
            getSuggestions(pos.latitude, pos.longitude);
          },
          function(error) {
            setModalMessage('Unable to get your current location.');
          });
        });

        suggestionModal.getElementsByClassName('close')[0]
          .addEventListener('click', function(e) {
          toggleModalHidden(true);
        });

        btnNearLoc.addEventListener('click', function(e) {
          clearSuggestions();
          getSuggestions(inpNearLoc.value);
        });

        getSugBtn.addEventListener('click', function(e) {
          toggleModalHidden(false);
        });

        suggestionList.addEventListener('click', function(e) {
          var reg = /loc-sug-item-([0-9]+)/;
          var match = reg.exec(e.target.id);
          var selectedIndex;
          if (match !== null) {
            selectedIndex = match[1];
            fillEventLocation(venues[selectedIndex].name,
              venues[selectedIndex].location);
            toggleModalHidden(true);
          }
        });

        function toggleModalHidden() {
          if (arguments.length > 0) {
            modalHidden = arguments[0];
          } else {
            modalHidden = !modalHidden;
          }
          if (modalHidden) {
            suggestionModal.classList.add('modal-hidden');
          } else {
            suggestionModal.classList.remove('modal-hidden');
          }
        }

        function setModalMessage(msg) {
          suggestionModal.getElementsByClassName('msg-area')[0].innerHTML = msg;
        }

        function fillEventLocation(name, address) {
          inpLocattion.value = name;
          inpAddr.value = address;
        }

        function getSuggestions() {
          var query;
          if (arguments.length === 1) {
            query = getZipQuery(arguments[0]);
          } else if (arguments.length > 1) {
            query = getLatLonQuery(arguments[0], arguments[1]);
          }
          fetch(query)
          .then(function(response){
            if(response.ok) {
              response.json().then(function(json) {
                // TODO It says Current Map Location when it's zip
                setModalMessage('Showing suggestions near ' + json.response.headerFullLocation);
                appendSuggestions(json);
              });
            } else {
              setModalMessage('Error getting data from Foursquare.')
            }
          });
        }

        function appendSuggestions(json) {
          venues = processSuggestions(json.response.groups[0].items);
          var listitem;
          clearSuggestions();
          var templ = document.getElementById('tmpl-loc-item').innerHTML;
          Mustache.parse(templ);
          for (var i = 0; i < venues.length; i++) {
            listitem = Mustache.render(templ, venues[i]);
            suggestionList.innerHTML += listitem;
          }
        }

        function processSuggestions(json) {
          var output = [];
          var address;
          for (var i = 0; i < json.length; i++) {
            address = json[i].venue.location.formattedAddress[0];
            address += ", " + json[i].venue.location.formattedAddress[1];
            output.push({
              index: i,
              name: json[i].venue.name,
              location: address
            });
          }
          return output;
        }

        function clearSuggestions() {
          suggestionList.innerHTML = "";
        }

        function getLatLonQuery(lat, lon) {
          var query = "https://api.foursquare.com/v2/venues/explore?ll=" +
                lat + "," + lon +
                "&client_id=HPTKFD3QU12Y0FPPQ0OVTZ51RFAYJ5L4104MNJJL0CW2HEEQ" +
                "&client_secret=YLBK5PYZW4FZNK0QIQX5SCJOQS4TYYEHR2LZ2SHYGJLXJCLE" +
                "&v=20130815&limit=20&venuePhotos=1";
          return query;
        }

        function getZipQuery(zip) {
          var query = "https://api.foursquare.com/v2/venues/explore?near=" +
                zip +
                "&client_id=HPTKFD3QU12Y0FPPQ0OVTZ51RFAYJ5L4104MNJJL0CW2HEEQ" +
                "&client_secret=YLBK5PYZW4FZNK0QIQX5SCJOQS4TYYEHR2LZ2SHYGJLXJCLE" +
                "&v=20130815&limit=20&venuePhotos=1";
          return query;
        }

      })(window,
        document.getElementById('btn-near-me'),
        document.getElementById('event-near-loc'),
        document.getElementById('btn-near-loc'),
        document.getElementById('event-loc-name'),
        document.getElementById('event-loc-addr'),
        document.getElementById('event-loc-pic'),
        document.getElementById('btn-get-sug'),
        document.getElementById('loc-modal'),
        document.getElementById('loc-sug-list'));
    </script>
  </body>
</html>
